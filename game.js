const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
let runningGame = false;
let loadedImages = 0;  // Zmienna do liczenia załadowanych obrazów

// Nasłuchuj kliknięcia na canvasie
canvas.addEventListener('click', function() {
    if (loadedImages >= 3) {
        startGame();  // Wywołaj funkcję startGame() po kliknięciu, tylko jeśli wszystkie obrazy są załadowane
    }
});

// Definicja obrazów
const startBackgroundImage = new Image();
startBackgroundImage.src = 'graphics/start_background.png';  // Ścieżka do obrazka

const gameBackgroundImage = new Image();
gameBackgroundImage.src = 'graphics/game_background.png';  // Ścieżka do obrazka

const spriteSheet = new Image();
spriteSheet.src = 'graphics/sprite_sheet.png';  // Ścieżka do sprite sheet'a

// Funkcje wczytania obrazów
startBackgroundImage.onload = function() {
    ++loadedImages;
    ctx.drawImage(startBackgroundImage, 0, 0, canvas.width, canvas.height);  // Rysuje obraz jako tło na początku
};

gameBackgroundImage.onload = function() {
    ++loadedImages;
};

spriteSheet.onload = function() {
    ++loadedImages;
};




const RECT_WIDTH = 128;
const RECT_HEIGHT = 162;

class Mole {
    constructor(index, x, y)
    {
        this.index = index;
        this.x = x;
        this.y = y;
        this.moleWidth = RECT_WIDTH;
        this.moleHeight = RECT_HEIGHT;
    }
    draw(state)
    {
        if (state <= 0) {
            ctx.drawImage(spriteSheet, 386-28-this.moleWidth, 325-14-this.moleHeight, this.moleWidth, this.moleHeight, this.x, this.y, this.moleWidth, this.moleHeight);
        }
        else if(state > this.lifespan*0.95 || state < this.lifespan*0.05)
        {
            ctx.drawImage(spriteSheet, 386, 325-14-this.moleHeight, this.moleWidth, this.moleHeight, this.x, this.y, this.moleWidth, this.moleHeight);
        }
        else if(state > self.lifespan*0.9 || state < self.lifespan*0.1)
        {
            ctx.drawImage(spriteSheet, 386+28+this.moleWidth, 325-14-this.moleHeight, this.moleWidth, this.moleHeight, this.x, this.y, this.moleWidth, this.moleHeight);
        }
        else
        {
            ctx.drawImage(spriteSheet, 386-28-this.moleWidth, 325, this.moleWidth, this.moleHeight, this.x, this.y, this.moleWidth, this.moleHeight);
        }
    }
    setLifespan(newLifespan)
    {
        this.lifespan = newLifespan
    }
    //TODO
    /*
    self.rect = pygame.Rect(x, y, RECT_WIDTH, RECT_HEIGHT)

    def is_clicked(self, event):

        hammer_rect = pygame.Rect(
            event.pos[0] - RECT_WIDTH/2,
            event.pos[1] - RECT_HEIGHT/2,
            int(0.35*RECT_WIDTH),
            int(0.35*RECT_HEIGHT)
        )

        if self.rect.colliderect(hammer_rect):
            return True
        else:
            return False
    */
}


class MolesBoard
{
    constructor(maxMoles, probabilityOfMole)
    {
        this.maxMoles = Math.min(maxMoles, 9);
        this.probabilityOfMole = probabilityOfMole;
        this.moles = [];
        this.states = new Array(9).fill(0);
        this.indexes = Array.from({ length: 9 }, (_, index) => index);
        
        for (let i = 0; i < 3; i++) {
            for (let j = 0; j < 3; j++) {
                const index = 3 * i + j;
                const x = 230 - 14 + (28 + 14 + RECT_WIDTH) * i;
                const y = 144 + (30 + RECT_HEIGHT) * j;
                this.moles.push(new Mole(index, x, y));
            }
        }
    }
    draw()
    {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(gameBackgroundImage, 0, 0, canvas.width, canvas.height);
        this.moles.forEach((mole, index) => {
            mole.draw(this.states[index]);
        });
    }

    getShuffledHoleIndexes(emptyHolesIndexes) {
        const shuffledHoleIndexes = [...emptyHolesIndexes];
        for (let i = shuffledHoleIndexes.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [shuffledHoleIndexes[i], shuffledHoleIndexes[j]] = [shuffledHoleIndexes[j], shuffledHoleIndexes[i]];
        }
        return shuffledHoleIndexes;
    }

    getNewMolesIndexes(emptyHolesIndexes) {

        const shuffledHoleIndexes = this.getShuffledHoleIndexes(emptyHolesIndexes);    
        const newMolesIndexes = [];
        const holesAmount = emptyHolesIndexes.length;

        for (let i = 0; i < holesAmount; i++) {
            const randomNumber = Math.random();
            if (randomNumber < this.probabilityOfMole) {
                if (newMolesIndexes.length < (this.maxMoles - (9-holesAmount))) {
                    newMolesIndexes.push(i);
                }
            }
        }
    
        return newMolesIndexes.map(index => shuffledHoleIndexes[index]);
    }

    updateBoard(lifespan, deltaTime) {
        const holeIndexes = [];
        for (let i = 0; i < 9; i++) {
            if (this.states[i] === 0) {
                holeIndexes.push(i);
            } else if (this.states[i] > 0) {
                this.states[i] = Math.max(0, this.states[i]-deltaTime);
            }
            else {
                this.states[i] = 0;
            }
        }
    
        const newMolesIndexes = this.getNewMolesIndexes(holeIndexes);
    
        for (const index of newMolesIndexes) {
            this.states[index] = lifespan;
        }
    }
}

let molesBoard = new MolesBoard(3, 0.005);


class Hammer
{
    constructor()
    {
        this.rotated = false;
    }
    setRotate(rotated)
    {
        this.rotated = rotated;
    }
    getRotate()
    {
        return this.rotated;
    }
    draw(mouseX, mouseY){
        if(!this.rotated)
        {
            ctx.drawImage(spriteSheet, 386, 325, RECT_WIDTH, RECT_HEIGHT, mouseX-RECT_WIDTH/2, mouseY-RECT_HEIGHT/2, RECT_WIDTH, RECT_HEIGHT);
        }
        else
        {
            ctx.drawImage(spriteSheet, 386+RECT_WIDTH+28, 325, RECT_WIDTH, RECT_HEIGHT, mouseX-RECT_WIDTH/2, mouseY-RECT_HEIGHT/2, RECT_WIDTH, RECT_HEIGHT);
        }
    }
}

let hammer = new Hammer();

let mouseX = 900/2;
let mouseY = 700/2;

async function startGame() {

    canvas.addEventListener('mousemove', (event) => {
        mouseX = event.offsetX;
        mouseY = event.offsetY;
    });
    canvas.addEventListener('mousedown', (event) => {
        event.preventDefault(); // Zapobiega zaznaczaniu tekstu na stronie

        hammer.setRotate(true);
    });
    
    canvas.addEventListener('mouseup', (event) => {
        hammer.setRotate(false);

    });

    let score = 0;
    secondsOfGame = 0;
    molesBoard.draw();
    canvas.style.cursor = 'none'; // Ukrywa kursor
    runningGame = true;
    requestAnimationFrame(gameLoop);
}

let lastTimestamp = 0;
const targetFps = 60;
const frameDuration = 1000 / targetFps; // czas na klatkę w ms
const gameDuration = 60;
let elapsedTime = 0; // Czas, który upłynął w sekundach


// Główna pętla gry
function gameLoop(timestamp) {
    // W rysowaniu młotka użyj aktualnej pozycji kursora

    if (!runningGame) return;

    const delta = timestamp - lastTimestamp;

    if (delta >= frameDuration) {

        lastTimestamp = timestamp - (delta % frameDuration); // Ustaw czas ostatniej klatki
        elapsedTime += delta / 1000; // Zaktualizuj czas gry (w sekundach)

        if (elapsedTime >= gameDuration) {
            runningGame = false; // Zatrzymaj grę po 60 sekundach
            alert("Gra się skończyła!"); // Możesz zmienić to na inny sposób powiadamiania
        } else {
            let lifespan = Math.floor((100 - elapsedTime)/4);
            molesBoard.updateBoard(lifespan, delta / 1000);
            molesBoard.draw();
            hammer.draw(mouseX, mouseY);

        }
    }

    requestAnimationFrame(gameLoop); // Wywołaj pętlę znowu
}

// Rozpocznij pętlę gry
requestAnimationFrame(gameLoop);



const Slonik = `
                                                                                      .,,*/(#%&&@@@@@@@@&%#((/*,,                                                                                       
                                                                        .*#&@@@@@@@@@@@@@@&%%%############%%%&@@@@@@@@@@@@@@&(,                                                                         
                                                                 ,#&@@@@@@&#((////*************************************///(#%&@@@@@&%(.                                                                 
                                                            *#@@@@@%(//**********************************************************//#%@@@@@#*                                                            
                                                        *%@@@&#/************************************************************************(#&@@@%*                                                        
                                                    .(@@@&#/********************************************************************************/#&@@@(.                                                    
                                                  (@@@&/****************************************************************************************(&@@@*                                                  
                                                &@@&(**********************************************************************************************(@@@#.                                               
                                             .&@@&/**************************************************************************************************/&@@#                                              
                                           .#@@%*******************************************************************************************************/&@@#                                            
                                         ./@@&/**********************************************************************************************************(@@@*..                                        
                            .*(#%@@@@@@@@@@@#/************************************************************************************************************/&@@@@@@@@@@@&%#/,                            
                    ,(#&@@@@@@&%#(//***/@@@(****************************************************************************************************************#@@%/***//(#%%&@@@@@@%(*.                   
              ,(&@@@@&&#(/**********//(@@@(*****************************************************************************************************************/#@@%////**********/#%&@@@@@#*.             
          *&@@@@%(*********///(((((((#&@@(*******************************//(#%%%&%%#(//*************************//(##%%&%%#((/*******************************/%@@%(((((((((///********/#&@@@@/.         
       /@@@@(********/(((((((((((((((&@@(****************************/#@@@@@@&##(#%&@@@@@&(/****************/#@@@@@@&%#(#%&@@@@@@(/***************************/&@@#(((((((((((((((///******/&@@@%.      
    .&@@@/******/(((((((((((((((((((%@@%***************************&@@@#.               /@@@@/************%@@@&,               *@@@@(**************************(@@@(((((((((((((((((((((/*****/%@@@*    
  .#@@%*****/((((((((((((((((((((((#&@@/************************/&@@&.                     /@@@(*******/%@@&.                     *@@@(*************************%@@%((((((((((((((((((((((((/****#@@@,  
 .@@@(***/(((((((((((((((((((((((((%@@#/***********************(@@&.                         #@@%/****/@@&,                         /@@@/***********************/@@@#((((((((((((((((((((((((((***/&@@( 
 &@&(***/((((((((((((((((((((((((((&@@(***********************(@@#                            *@@%/**/@@%.                           *@@&/***********************&@@%(((((((((((((((((((((((((((/***%@@*
*@@#***(((((((((((((((((((((((((((#@@%/***********************&@&,                .,*,         #@@(**&@&*         ,*,.                (@@#***********************(@@&((((((((((((((((((((((((((((/**/@@#
&@&(***/((((////******************#@@%/**********************/@@#.             ,@@@@@@@@%.     *@@#*/@@%.     .#@@@@@@@%.             *@@&/**********************/@@&(//*****************///(((((/**/%@@
@@&/******************************%@@(***********************/@@%.            ,&@@@@@@@@@&     /@@#**@@&,    .%@@@@@@@@@@             /@@#************************@@&(*******************************#@@
%@@(******************************&@&(************************#@@/            .%@@@@@@@@@%    .@@&/**(@@#     (@@@@@@@@@%            .@@@/************************&@@(******************************/%@&
*@@#******************************@@&(************************/#@@/             ,@@@@@@@.    ,@@&/****#@@(     ,%@@@@@&,            ,&@@/************************/&@@#******************************/@@#
 @@&/****************************/@@&/**************************#@@@,                      .%@@%*******(@@@*                      .#@@&**************************(%@@#******************************#@@/
 /@@#/***************************/@@&/***************************/#@@@#.                 /&@@%/**********(@@@%,                 *&@@&/**************************((%@@#*****************************/@@%.
 .%@@(***************************/@@&/******************************/%@@@@%#*,.   .,(#&@@@&(/**************/#@@@@%#*,.   .,/#&@@@&(/***************************/((%@@#/****************************&@@* 
  ,&@&/***************************&@&(**********************************/#%&@@@@@@@@&%#(***********************/(%&@@@@@@@@&%#(/******************************/(((&@@#/***************************%@@(  
   *@@&***************************#@@#***********************************************************************************************************************/((((@@@#/**************************#@@%   
    *&@@/*************************/@@%/*********************************************************************************************************************/((((%@@&(/************************/%@@(    
     ,@@@(*************************%@@(*****************************************************//#&@@@@@@&%(//************************************************/(((((@@@#(/***********************/%@@/     
       &@@%************************(@@%/*************************************************#@@@@@&#(//((%@@@@@@%/*******************************************((((((%@@@(/***********************/@@@*      
        *@@&/**********************/#@@(**********************************************(@@@&(/*************//%@@@#/**************************************/((((((#@@@#(/**********************%@@%.       
         .#@@&**********************/&@@/**********************************************///********************//**************************************/(((((((#&@@#((/********************#@@@,         
           ,&@@%/********************(&@@/***********************************************************************************************************((((((((#&@@%((/******************/(@@@/           
             .&@@&/*******************/@@@(*********************************(%(******************************************(#(***********************((((((((((&@@%(((******************#@@&/             
               .#@@@#/*****************/@@@#*******************************/#@@#****************************************&@@%********************/(((((((((((&@@%(((***************/(&@@&*               
                ,%@@@@@#/****************%@@%/*************/#@@@@@@@@@@#/***/%@@#***************///////****************%@@%***/(&@@@@@@@@@%(**/(((((((((((#@@@#(((*************/(&@@@@*                 
                ,%@&*(&@@@@(/*************(@@&/**********#@@@%.      ,%@@@%**/&@@/*********/#@@@@@@@@@@@@@%/**********#@@&*/#@@@&*       (@@@%(((((((((((&@@@((((**********/(%@@@@#%@@*                 
                .%@@*****(@@@@@@%/*********/%@@&(*******#@@(            *@@@#*(@@@*******/#@@&/*********/%@@@********/&@@//@@@*            /@@&((((((((%@@@#((((/*****/#@@@@@@#***/%@@,                 
                 #@@/********/(%@@@@@@@@@@@@@@@@@%((/**/@@#.            ,*&@@(*#@@%*********************************/%@@(*@@%.              #@@%(((((#@@@@@@@@@@@@@@@@@@&(//******/%@@.                 
                 (@@(****************////////((%@@@%(((%@@*            .**@@&/*/@@@(********************************(@@%/*&@&*              .@@@#((#@@@&#((#####(///**************(&@&                  
                 ,&@&*************************/((%@@@&(@@%.           .**&@@(***(@@%*******************************/%@@(**/@@&,              &@@#%@@@&#((((((((/*****************/#@@/                  
                  %@@(**************************(((#@@@@@#.          .*/&@@(*****@@&(******************************/@@%//((#@@@,             #@@@@@%((((((((((/*****************/(&@@.                  
                  *@@&***************************/((((&@@#          ,*#@@&/******#@@#***********///////************#@@%((((((&@@%            (@@&#((((((((((/******************((%@@(                   
                   %@@(****************************/(((@@#.       .*(@@@%(((((((((@@%/*****/#@@@@@@@@@@@@@%/*******@@@#(((((((#@@@/          (@@%((((((((((******************/((#&@&,                   
                   .@@&/*****************************((@@%.      ,/@@@&(((((((((((&@&(*****/%&(*********/#%/******/@@&#(((((((((#@@@/        %@@#((((((((/*****************/((((%@@/                    
                    ,@@%/******************************%@@*    ,#@@@@&#(((((((((((%@@#****************************#@@%(((((((((((%@@@@(     .@@@#((((((*******************(((((%@@#                     
                     *@@%/*****************************(@@# .*@@@@##&@@@@@&#((((((#@@#/***************************&@@%(((((#%@@@@@@##@@@&*  #@@%((((/*******************((((((#@@%                      
                      /@@#/****************************/#@@@@@@%#((((((##%@@@@@@@&%@@%/**************************/@@@&&@@@@@@&##(((((((%@@@@@@&((/*******************/(((((((%@@&                       
                       /@@%******************************////**/((((((((((((((#%%&@@@%/**************************/@@@@&%##((((((((((((((((###(//*******************/((((((((%@@&                        
                        /@@&**************************************/(((((((((((((((#@@&/**************************/@@@#(((((((((((((((((((((/*********************/(((((((((%@@%                         
                         ,@@@(****************************************/(((((((((((#&@&/**************************(@@@((((((((((((((((((/**********************/(((((((((((&@@/                          
                           &@@#/*******************************************/((((((#&@&/**************************(@@@(((((((((((((/*************************/(((((((((((#@@@*                           
                            *@@&/****************//#%@@@@@@@@@@@@%#(///**********/(&@&/**************************(@@@(((((((/*********//(#&@@@@@@@@@@@@%(((((((((((((((&@@%                             
                             .#@@%************#@@@@@&#(/*****//(#&@@@@@@@@%/******/&@&/**************************(@@&/**********(&@@@@@@@@&#(/******/(#@@@@@@%(((((((%@@@,                              
                               ,&@@%/******#@@@@(/********************//(#@@@@@@%//&@&/**************************/@@&/****(%@@@@@@#///*******************/(#@@@@#((#@@@/                                
                                 *@@@%((*(@@@#/******************************/(%@@@@@%/**************************/@@&/#&@@@@#(/****************************((#%@@@@@@#.                                 
                                   *@@@%@@@%/*********************************(@@@@@@%/**************************/@@@@@&(/**********************************/((#&@@&.                                   
                                     *&@@@(*********************************(&@@#*(@@#/***************************&@@#***************************************/(((%@@%                                   
                                     .%@@(*********************************#@@%/**#@@#****************************#@@#***************************************/((((%@@(                                  
                                     (@@#*********************************%@@%****%@&(****************************(@@%/***************************************/((((%@@/                                 
                                    ,&@&*********************************#@@&*****@@&/****************************/@@&/***************************************/((((#@@%.                                
                                    /@@(*********************************@@@(****(@@%/****************************/&@@(****************************************(((((%@@*                                
                                    #@@/********************************/@@@/****/%%/****************************((%@@#****************************************/((((%@@(                                
                                   .&@&/*********************************@@@(**********************************/(((&@@(****************************************/((((#@@%                                
                                   .&@%/*********************************#@@&(/******************************/((((#@@&/****************************************/((((#&@&                                
                                   .@@%/**********************************&@@%((/**************************/(((((#@@@(*****************************************/((((#&@@                                
                                   .&@&/******/(#&@@@@&%(/*******////******%@@&#((((//****************///(((((((%@@@##&@@@@&%(/*******////********/#&@@@@@@@%(/(((((#@@%                                
                                    /@@(***/(@@@&#*,,*(&@@@%/#@@@@@@@@@@%/*%@@@@%((((((((((//////(((((((((((((#&@@@@@&#/,,*(&@@@%/#@@@@@@@@@@%//%@@@%*.   ,(&@@&#(((%@@*                                
                                    .%@@/*/&@@*          ,%@@@%.      .#@@@@%,*&@@@#((((((((((((((((((((((((%@@@@@@/          .&@@@#.      .%@@@@%,          ,%@@%(%@@(                                 
                                      #@@&%@@,           (@@/            /@@% ,*,#@@@@%#((((((((((((((((%@@@@@#%@@.           #@@#            *@@(         .***%@@@@@(                                  
                                       .@@@@@*          ,&@#              %@@(******/%@@@@@@@@@@@@@@@@@@@&*.#@@@@@*          ,&@&              (@@*     .*****#@@@@&.                                   
                                          *%@@@@&#*.    .%@@.            .@@@(****/(%&@@@@@@#/////*,,.        ,#@@@@@&#*.    .%@@.             &@@*,,,*/(%&@@@@@%,                                      
                                              ,/#&@@@@@@@@@@@@@&%%%%%%&@@@@@@@@@@@@@@@%(*.                        .*(&@@@@@@@@@@@@@@&&%%%&&&@@@@@@@@@@@@@@&(*.                                          
`;